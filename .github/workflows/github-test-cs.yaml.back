name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
permissions:
  contents: write
on: [push]
jobs:
  test-codespace:
    runs-on: ubuntu-22.04
    env:
      RepositoryName: "codespaces-synchronizer"
      DT_TENANT: ${{ secrets.DT_TENANT }}
      DT_OPERATOR_TOKEN: ${{ secrets.DT_OPERATOR_TOKEN }}
      DT_INGEST_TOKEN: ${{ secrets.DT_INGEST_TOKEN }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Add .env file for running locally with VS Code extension
        run: |
            cd .devcontainer 
            cat <<EOF >> runlocal/.env
            DT_TENANT=$DT_TENANT
            DT_OPERATOR_TOKEN=$DT_OPERATOR_TOKEN
            DT_INGEST_TOKEN=$DT_INGEST_TOKEN
            EOF
            sed -i '/"runArgs": \["--init", "--privileged", "--network=host"\]/c\  "runArgs": ["--init", "--privileged", "--network=host", "--env-file",".devcontainer/runlocal/.env"]' devcontainer.json
            echo "This is the devcontainer.json config for reading local variables"; cat devcontainer.json
      - name: Test Codespace (devcontainer) build and run commands
        uses: devcontainers/ci@v0.3
        with:
          imageName: shinojosa/dt-enablement
          cacheFrom: shinojosa/dt-enablement
          push: never
          runCmd: |
            zsh .devcontainer/test/framework.sh
            source .devcontainer/util/functions.sh
            echo "waiting for the Todo App"; 
            waitForAllReadyPods todoapp
            echo "------ some cmds... ------" ; pwd ; ls -las ; ls / ;
            echo "------ this is the tenant $DT_TENANT ------" 
            echo "------ I AM ------" ; whoami
            echo "------   Docker ps.   ------- " ; docker ps
            echo "env" ; env
            echo "curling the TodoApp"
            curl -v http://localhost:30100 | grep -q "todo" && echo "TODO App Running" || echo "TODO App Not Running"
            echo "Curling the todo app running in the Codespace container"; docker ps
            docker ps --format '{{json .}}' | jq -s '.[] | select(.Image | contains("vsc")) | .Names'
            containername=$(docker ps --format '{{json .}}' | jq -s '.[] | select(.Image | contains("vsc")) | .Names')
            containername=${containername//\"/}
            echo "------ containername $containername ------"
            echo "------ curl 30100 inside container ------"
            docker exec $containername zsh -c "curl -v http://127.0.0.1:30100"
            echo "------ env inside container ------"
            docker exec $containername zsh -c "env"
            echo "------ kubectl inside container ------"
            docker exec $containername zsh -c "kubectl get all -A"
            echo "------ kubectl outside container ------" ; kubectl get all -A
      - name: After creation of VSCode stuff
        run: |
            echo "whats happening?"
            whoami
            docker ps 
            echo "Curling the todo app running in the Codespace container"; docker ps
            docker ps --format '{{json .}}' | jq -s '.[] | select(.Image | contains("vsc")) | .Names'
            containername=$(docker ps --format '{{json .}}' | jq -s '.[] | select(.Image | contains("vsc")) | .Names')
            containername=${containername//\"/}
            echo "------ containername $containername ------"
            echo "------ env inside container ------"
            docker exec $containername zsh -c "env"
            echo "------ kubectl inside container ------"
            docker exec $containername zsh -c "kubectl get all -A"
            echo "------ waitForPods inside container ------"
            docker exec $containername zsh -c "waitForAllReadyPods dynatrace"
            echo "------ curl 30100 inside container ------"
            docker exec $containername zsh -c "curl -v http://localhost:30100"